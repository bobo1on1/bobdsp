<!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Connection settings</title>
    <link type="text/css" href="css/dot-luv/jquery-ui-1.8.23.custom.css" rel="stylesheet" />
    <script type="text/javascript" src="js/jquery-1.8.0.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.23.custom.min.js"></script>
    <script type="text/javascript" src="js/json2.js"></script>
  </head>

  <body>

    <script>
      var portindex = -1;

      $(document).ready(function()
      {
        //get jack connections
        $.getJSON('./connections', ParseConnections);

        //get jack ports
        GetPorts();

        //tell bobdsp to reload the connections from connections.xml
        $("#reload").click(function()
        {
          var postjson = JSON.stringify({"reload" : true});
          $.post("./connections", postjson, ParseConnections);
        });

        //when the reset button is clicked, get the jack connections again
        $("#reset").click(function()
        {
          $.getJSON('./connections', ParseConnections);
        });

        $("#addnew").click(function()
        {
          AddRow($("#connections"), "", "", "none", true);
        });

        $("#apply").click(function()
        {
          PostConnections(false);
        });

        $("#save").click(function()
        {
          PostConnections(true);
        });

        $("#add").click(function()
        {
          //get the current selection
          var selectedoutput = $("#outports input:checked");
          var selectedinput = $("#inports input:checked");

          //add as new row
          if (selectedoutput.length > 0 && selectedinput.length > 0)
          {
            var outputstr = EscapeRegex(selectedoutput.attr("value"));
            var inputstr = EscapeRegex(selectedinput.attr("value"));
            AddRow($("#connections"), inputstr, outputstr, "none", true);
          }
        });

        $("#addregex").click(function()
        {
          //get the current selection
          var selectedoutput = $("#outports input:checked");
          var selectedinput = $("#inports input:checked");

          //add as new row
          if (selectedoutput.length > 0 && selectedinput.length > 0)
          {
            var outputstr = Regexify(EscapeRegex(selectedoutput.attr("value")));
            var inputstr = Regexify(EscapeRegex(selectedinput.attr("value")));
            AddRow($("#connections"), inputstr, outputstr, "none", true);
          }
        });
      });

      var isunloading = false;
      $(window).on('beforeunload',function() { isunloading = true; });

      function PostConnections(save)
      {
        var connections = {"connection": []};

        var it = 0;
        for (var i = 1; i < $("#connections").get(0).rows.length; i++)
        {
          var inputs = $("#connections").get(0).rows[i].getElementsByTagName("input");
          var intxt;
          var outtxt;
          for (var j = 0; j < inputs.length; j++)
          {
            if (inputs[j].name == "out")
              outtxt = inputs[j].value;
            else if (inputs[j].name == "in")
              intxt = inputs[j].value;
          }

          if (outtxt == "" || intxt == "")
            continue; //empty is invalid

          var select = $("#connections").get(0).rows[i].getElementsByTagName("select");

          connections.connection[it++] = {"out" : outtxt, "in" : intxt, "disconnect": select[0].value};
        }

        var postjson = JSON.stringify({"connections" : connections, "save" : save});
        $.post("./connections", postjson, ParseConnections);
      }

      function ParseConnections(data)
      {
        //if this is called from the reset button callback, the table needs to be cleared first
        $("#connections").empty();

        //add header
        $("#connections").append("<tr><th></th><th></th><th>Out</th><th></td><th>In</th><th>Disconnect</th></tr>");

        if (data.connections.connection.length == 0)
        {
          //no data, add empty row
          AddRow($("#connections"), "", "", "none", true);
        }
        else
        {
          //make a textbox for the out and in regexes, and make an edit button
          for (var i = 0; i < data.connections.connection.length; i++)
            AddRow($("#connections"), data.connections.connection[i].in, data.connections.connection[i].out,
                data.connections.connection[i].disconnect, false);
        }
      }

      //TODO: escape instr and outstr here, or use the javascript DOM to generate elements
      function AddRow(table, instr, outstr, disconnect, editable)
      {
        var readonly;
        if (editable)
          readonly = "";
        else
          readonly = "readonly=\"readonly\"";

        var outtext = "<input type=\"text\" name=\"out\" style=\"width:99%\" " + readonly + " value=\"" + outstr + "\"/>";
        var intext  = "<input type=\"text\" name=\"in\"  style=\"width:99%\" " + readonly + " value=\"" + instr  + "\"/>";
        var editbutton = "<button type=\"button\" id=\"editbutton\" onclick=\"SetMutable(this.parentNode.parentNode)\">Edit</button>";
        var removebutton = "<button type=\"button\" id=\"removebutton\" onclick=\"Remove(this.parentNode.parentNode)\">Remove</button>";
        var upbutton = "<button type=\"button\" id=\"upbutton\" onclick=\"Move(this.parentNode.parentNode, true)\">&uarr;</button>";
        var downbutton = "<button type=\"button\" id=\"downbutton\" onclick=\"Move(this.parentNode.parentNode, false)\">&darr;</button>";

        var disconnectstr = "<select style=\"width:100%\">";
        var disconnectopts = ["none", "in", "out", "both"];
        for (var j = 0; j < disconnectopts.length; j++)
          disconnectstr += AddOption(disconnectopts[j], disconnect, editable);

        disconnectstr += "</select>";

        table.append("<tr><td>" + upbutton + "</td><td>" + downbutton + "<td style=\"width:50%\">" + outtext +
                     "</td><td>&rarr;</td><td style=\"width:50%\">" + intext + "</td><td>" + disconnectstr +
                     "</td><td>" + editbutton + "</td><td>" + removebutton + "</td></tr>");
      }

      function AddOption(name, disconnect, editable)
      {
        var str = "<option value=\"" + name + "\"";

        if (name == disconnect)
          str += "selected=\"selected\"";
        else if (!editable)
          str += "disabled=\"disabled\"";

        str += ">" + name + "</option>";

        return str;
      }

      function SetMutable(it)
      {
        var inputs = it.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++)
          inputs[i].removeAttribute("readonly");

        var selects = it.getElementsByTagName("select");
        for (var i = 0; i < selects.length; i++)
        {
          var options = selects[i].getElementsByTagName("option");
          for (var j = 0; j < options.length; j++)
           options[j].removeAttribute("disabled");
        }
      }

      function Remove(it)
      {
        //if there's only one entry left (plus the header), add an empty row
        if (it.parentNode.rows.length == 2)
          AddRow($("#connections"), "", "", "none", true);

        it.parentNode.deleteRow(it.rowIndex);
      }

      function Move(it, up)
      {
        var row = it.rowIndex;
        if ((row <= 1 && up) || (row >= it.parentNode.rows.length - 1 && !up))
          return;

        var newrow;
        if (up)
          newrow = row - 1;
        else
          newrow = row + 1;
        
        var oldhtml = it.parentNode.rows[newrow].innerHTML;
        it.parentNode.rows[newrow].innerHTML = it.innerHTML;
        it.innerHTML = oldhtml;
      }

      function ErrorHandler()
      {
        //prevent error message showing from cancelled xmlhttprequest when the user refreshes the page
        if (!isunloading)
        {
          $("#errormessagetop,#errormessagebot").html("Connection to bobdsp lost!");
          document.bgColor="#FFBBBB";
        }

        setTimeout("GetPorts()", 1000);
      }

      function GetPorts()
      {
        $.ajax({ 
          url: "./ports", 
          dataType: "json", 
          success: ParsePorts, 
          timeout: 10000,
          error: ErrorHandler
        });
      }

      function ParsePorts(data)
      {
        document.bgColor="#FFFFFF";
        $("#errormessagetop,#errormessagebot").empty();

        if (data.ports.portindex != portindex)
        {
          //store the current selection
          var selectedoutput = $("#outports input:checked");
          var selectedinput = $("#inports input:checked");

          //clear the tables
          $("#outports").empty();
          $("#inports").empty();

          //add header
          $("#outports").append("<tr><th>Jack output ports</th></tr>");
          $("#inports").append("<tr><th>Jack input ports</th></tr>");

          for (var i = 0; i < data.ports.port.length; i++)
          {
            var checked = "";
            if (data.ports.port[i].type == "output")
            {
              if (selectedoutput.length > 0 && selectedoutput.attr("value") == data.ports.port[i].name)
                checked = "checked";
              AddPortRow($("#outports"), "output", data.ports.port[i].name, checked);
            }
            else if (data.ports.port[i].type == "input")
            {
              if (selectedinput.length > 0 && selectedinput.attr("value") == data.ports.port[i].name)
                checked = "checked";
              AddPortRow($("#inports"), "input", data.ports.port[i].name, checked);
            }
          }

          portindex = data.ports.portindex;
        }

        //get json again, but set the timeout to 60 seconds and pass the portindex
        //this way, bobdsp will wait for the ports to change or the timeout to occur
        //before sending the ports
        var timeout = 60000;
        var postjson = JSON.stringify({"timeout" : timeout, "portindex" : portindex});

        $.ajax({ 
          type: "POST",
          url: "./ports", 
          data: postjson,
          dataType: "json", 
          success: ParsePorts, 
          timeout: timeout + 10000,
          error: ErrorHandler
        });
      }

      //TODO: escape for html here
      function AddPortRow(table, type, name, checked)
      {
        var option = "<input type=\"radio\" name=\"" + type + "\" value=\"" + name + "\" " + checked + ">";
        table.append("<tr><td>" + option + name + "</td></tr>");
      }

      //turns any number of the client name into [0-9]*
      function Regexify(instr)
      {
        var out = "";
        var innumber = false;
        var inportname = false;
        for (var i = 0; i < instr.length; i++)
        {
          var currchar = instr.charAt(i);
          if (currchar == ':')
            inportname = true;

          if (innumber)
          {
            if (currchar < '0' || currchar > '9')
            {
              innumber = false;
              out += "[0-9]*";
              out += currchar;
            }
          }
          else
          {
            if (!inportname && currchar >= '0' && currchar <= '9')
            {
              if (i == instr.length - 1)
                out += "[0-9]*";
              else
                innumber = true;
            }
            else
            {
              out += currchar;
            }
          }
        }
        return out;
      }

      function EscapeRegex(instr)
      {
        var escapechars = ".^$*+?()[]{\\";
        var out = "";

        for (var i = 0; i < instr.length; i++)
        {
          var currchar = instr.charAt(i);
          var found = false;
          //TODO: figure out why escapechars.search(currchar) doesn't work
          for (var j = 0; j < escapechars.length; j++)
          {
            if (currchar == escapechars.charAt(j))
            {
              out += "\\";
              out += currchar;
              found = true;
              break;
            }
          }

          if (!found)
            out += currchar;
        }

        return out;
      }

    </script>

    <div id="errormessagetop" style="color: black; background-color: red; font-size: 30pt; font-weight:bold; text-align:center"></div>

    <table width=100%>
      <tr><td>
        <table id="connections"></table>
      </td></tr>
      <tr><td>
        <button type="button" id="reload">Reload</button>
        <button type="button" id="reset">Reset</button>
        <button type="button" id="addnew">Add new</button>
        <button type="button" id="apply">Apply</button>
        <button type="button" id="save">Apply &amp; save</button>
      </td></tr>
    </table>

    <table>
      <tr>
        <td valign="top"><table id="outports"></table></td>
        <td valign="top"><table id="inports"></table></td>
      </tr>
      <tr><td>
        <button type="button" id="add">Add</button>
        <button type="button" id="addregex">Add as regex</button>
      </td></tr>
    </table>

    <div id="errormessagebot" style="color: black; background-color: red; font-size: 30pt; font-weight:bold; text-align:center"></div>

 </body>

 </html>
